<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>培根培根書庫 - 您的專屬小說世界</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background for tech feel */
            color: #c9d1d9; /* Light text color */
            overflow: hidden; /* Prevent scrolling during startup animation */
        }
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #161b22;
        }
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444c56;
        }
        .gradient-text {
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .input-field {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .novel-card {
            background-color: #161b22;
            border: 1px solid #30363d;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .novel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .book-valet-btn {
            position: fixed; /* Changed to fixed for global positioning */
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(45deg, #ec4899, #8b5cf6);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            z-index: 100; /* Higher z-index to be above modals */
        }
        .book-valet-btn:hover {
            transform: scale(1.1);
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
        }
        .chat-user {
            background-color: #30363d;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-ai {
            background-color: #8b5cf6;
            align-self: flex-start;
            margin-right: auto;
        }
        .generate-btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* Linear Progress Bar Styles */
        .progress-bar-container {
            width: 200px;
            height: 10px;
            background-color: #30363d;
            border-radius: 5px;
            overflow: hidden;
            margin-left: 1rem;
            display: none; /* Hidden by default */
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            transition: width 0.3s ease-in-out;
        }

        /* Startup Animation Overlay */
        #startupAnimationOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1117; /* Match body background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* Ensure it's on top */
            color: #c9d1d9;
            font-size: 2.5rem;
            font-weight: 700;
            opacity: 1;
            transition: opacity 1s ease-out, visibility 1s ease-out;
        }
        #startupAnimationOverlay.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        #startupAnimationOverlay .gradient-text {
            font-size: 4rem; /* Larger title for animation */
            margin-bottom: 1rem;
            animation: pulse 1.5s infinite alternate; /* Pulsating effect */
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        #startupAnimationOverlay .loading-spinner {
            width: 60px;
            height: 60px;
            border-width: 5px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="startupAnimationOverlay">
        <h1 class="gradient-text">培根培根書庫</h1>
        <div class="loading-spinner"></div>
        <p class="mt-4 text-xl">載入中...</p>
    </div>

    <header class="bg-[#161b22] p-4 shadow-lg flex justify-between items-center z-10 hidden">
        <h1 id="siteTitleHeader" class="text-3xl font-bold gradient-text">培根培根書庫</h1>
        <nav class="flex items-center space-x-6">
            <button id="homeBtn" class="text-lg hover:text-purple-400 transition-colors">首頁</button>
            <div class="flex items-center">
                <button id="onlineComicsBtn" class="btn-primary text-lg">線上漫畫</button>
                <div id="comicsProgressBarContainer" class="progress-bar-container">
                    <div id="comicsProgressBarFill" class="progress-bar-fill"></div>
                </div>
            </div>
            <span class="text-lg text-gray-400">註冊功能即將上線</span>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-6 hidden">
        <section id="novelGenerationSection" class="mb-8 p-6 rounded-lg bg-[#161b22] border border-[#30363d] shadow-md">
            <h2 class="text-2xl font-semibold mb-4 gradient-text">立即生成一本新小說</h2>
            <p class="text-gray-400 mb-4">請輸入您想生成的小說類型或主題 (例如: 科幻、奇幻、懸疑、愛情、未來都市、修仙等)。</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="customGenreInput" placeholder="只能寫你要看哪種類型的小說" class="input-field flex-grow">
                <button id="generateCustomNovelBtn" class="btn-primary flex-shrink-0">
                    <span id="generateBtnText">生成新小說</span>
                    <span id="generateBtnSpinner" class="loading-spinner w-5 h-5 ml-2 hidden"></span>
                </button>
            </div>
            <p id="generateStatus" class="text-center text-blue-400 mt-4 hidden"></p>
        </section>

        <section id="novelFilterSection" class="mb-8 flex flex-wrap items-center justify-center md:justify-start gap-4">
            <h2 class="text-2xl font-semibold mr-4">篩選類型:</h2>
            <div id="genreFilters" class="flex flex-wrap gap-3">
                </div>
        </section>

        <section id="novelList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </section>

        <section id="comicsSection" class="hidden">
            <h2 class="text-3xl font-bold gradient-text mb-6 text-center">線上漫畫</h2>
            <div id="comicsContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </section>


        <div id="messageBox" class="fixed bottom-8 right-8 bg-blue-600 text-white p-4 rounded-lg shadow-xl hidden z-50">
            <p id="messageText"></p>
            <button class="absolute top-1 right-2 text-white text-xl" onclick="document.getElementById('messageBox').classList.add('hidden')">&times;</button>
        </div>
    </main>

    <footer class="bg-[#161b22] p-4 text-center text-gray-500 text-sm mt-8 hidden">
        © 2025 培根培根書庫. All rights reserved.
    </footer>

    <div id="novelModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-3xl h-5/6 flex flex-col">
            <h2 id="novelTitle" class="text-3xl font-bold gradient-text mb-4 text-center"></h2>
            <div id="novelContent" class="flex-grow overflow-y-auto text-lg leading-relaxed text-gray-300 pr-4">
                <div id="novelLoading" class="flex justify-center items-center h-full hidden">
                    <div class="loading-spinner"></div>
                    <p class="ml-4 text-xl">正在為您生成小說內容，請稍候...</p>
                </div>
            </div>
            <button id="closeNovelModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
        </div>
    </div>

    <div id="bookValetBtn" class="book-valet-btn hidden">
        <i class="fas fa-robot"></i>
    </div>

    <div id="bookValetModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md h-3/4 flex flex-col">
            <h2 class="text-3xl font-bold text-center mb-6 gradient-text">書僮</h2>
            <div id="chatHistory" class="flex-grow overflow-y-auto mb-4 p-2 rounded-lg bg-[#0d1117] border border-[#30363d] flex flex-col space-y-3">
                <div class="chat-message chat-ai">您好，我是您的專屬書僮。請提出關於這本小說的問題。</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="請輸入您的問題..." class="input-field flex-grow">
                <button id="sendChatBtn" class="btn-primary px-4 py-2">發送</button>
            </div>
            <button id="closeBookValetModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
        </div>
    </div>


    <script type="module">
        // Gemini API Configuration
        const GEMINI_API_KEY = "AIzaSyARZ8ZtqPF2kRCNEMsHFtxZHXWFkg4YJjg";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

        // Constants for novel generation
        const TOTAL_INITIAL_NOVELS = 50; // Total number of novel cards to display initially

        // UI Elements
        const startupAnimationOverlay = document.getElementById('startupAnimationOverlay'); // Startup animation overlay
        const header = document.querySelector('header');
        const main = document.querySelector('main');
        const footer = document.querySelector('footer');
        const novelGenerationSection = document.getElementById('novelGenerationSection');
        const novelFilterSection = document.getElementById('novelFilterSection');
        const novelList = document.getElementById('novelList');
        const comicsSection = document.getElementById('comicsSection');
        const comicsContent = document.getElementById('comicsContent');
        const onlineComicsBtn = document.getElementById('onlineComicsBtn');
        const comicsProgressBarContainer = document.getElementById('comicsProgressBarContainer');
        const comicsProgressBarFill = document.getElementById('comicsProgressBarFill');
        const novelModal = document.getElementById('novelModal');
        const novelTitleElem = document.getElementById('novelTitle');
        const novelContentElem = document.getElementById('novelContent');
        const novelLoading = document.getElementById('novelLoading');
        const closeNovelModalBtn = document.getElementById('closeNovelModal');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const customGenreInput = document.getElementById('customGenreInput');
        const generateCustomNovelBtn = document.getElementById('generateCustomNovelBtn');
        const generateBtnText = document.getElementById('generateBtnText');
        const generateBtnSpinner = document.getElementById('generateBtnSpinner');
        const generateStatus = document.getElementById('generateStatus');
        const bookValetBtn = document.getElementById('bookValetBtn');
        const bookValetModal = document.getElementById('bookValetModal');
        const chatHistoryElem = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const closeBookValetModalBtn = document.getElementById('closeBookValetModal');


        // State variables
        const genres = ['科幻', '奇幻', '浪漫', '懸疑', '武俠', '歷史', '都市', '靈異'];
        let allNovels = []; // Store all generated novel metadata and content
        let currentFilter = '所有';
        let currentNovelContent = ''; // To store the content of the currently open novel for the book valet
        let currentView = 'novels'; // 'novels' or 'comics'

        // --- Utility Functions ---

        /**
         * Displays a message box to the user.
         * @param {string} message The message to display.
         * @param {string} type The type of message (e.g., 'success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'bg-blue-600');
            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-blue-600');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Generates a random novel title.
         * @returns {string} A random novel title.
         */
        function generateNovelTitle() {
            const prefixes = ['星際', '永恆', '暗影', '迷霧', '失落的', '穿越', '重生之', '我的'];
            const nouns = ['傳說', '紀元', '之歌', '秘境', '帝國', '冒險', '戀人', '偵探'];
            const suffixes = ['記', '錄', '史', '物語', '之謎', '風雲', '歸來', '的秘密'];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
        }

        /**
         * Generates a short novel description.
         * @param {string} genre The genre of the novel.
         * @returns {string} A short description.
         */
        function generateNovelDescription(genre) {
            const descriptions = {
                '科幻': '在遙遠的未來，人類探索未知宇宙的史詩。',
                '奇幻': '一個充滿魔法與神秘生物的異世界冒險。',
                '浪漫': '一段跨越時空的愛情故事，感人至深。',
                '懸疑': '層層迷霧下的真相，考驗智慧的極限。',
                '武俠': '江湖恩怨，俠骨柔情，一代宗師的崛起。',
                '歷史': '回溯千年，見證歷史洪流中的英雄與傳奇。',
                '都市': '現代都市的愛恨情仇，職場與人生的挑戰。',
                '靈異': '夜半時分，鬼影幢幢，挑戰膽量的禁忌之談。'
            };
            return descriptions[genre] || '一個引人入勝的故事，等待您的探索。';
        }

        /**
         * Generates a very long placeholder novel content.
         * This content is pre-loaded for the initial 50 novels.
         * It is in Traditional Chinese for fastest load.
         * @param {string} title The novel title.
         * @param {string} genre The novel genre.
         * @returns {string} Pre-written long content for a novel.
         */
        function generateStaticNovelContent(title, genre) {
            if (title === "哈利波特：阿茲卡班的逃犯") {
                return `## 哈利波特：阿茲卡班的逃犯

第一章：貓頭鷹郵件
哈利波特在德思禮家度過了一個漫長的暑假，他收到了一封來自霍格華茲的信，警告他不要使用魔法。然而，他意外地膨脹了他的阿姨瑪姬，不得不逃離德思禮家。他搭乘騎士公車前往倫敦，並在那裡遇到了魔法部長康尼留斯·夫子。夫子沒有懲罰哈利，反而安排他住在破釜酒吧，這讓哈利感到非常困惑。

第二章：騎士公車
哈利在破釜酒吧度過了他暑假的最後幾週，他買了新的教科書和魔法用品。他得知了一個令人震驚的消息：一個名叫天狼星·布萊克的人從阿茲卡班監獄逃脫了，他被認為是佛地魔的忠實追隨者，並且殺害了哈利的父母。這個消息讓哈利感到不安。

第三章：預言與警告
在霍格華茲特快列車上，哈利、榮恩和妙麗遇到了新的黑魔法防禦術教授雷木思·路平。路平教授在火車上擊退了攝魂怪，這些生物是阿茲卡班的守衛，它們能吸走人們的快樂。哈利發現自己對攝魂怪特別敏感，它們讓他回憶起父母去世的場景。

第四章：新的黑魔法防禦術教授
路平教授的教學方法非常獨特，他讓學生們面對他們的恐懼。哈利在路平教授的幫助下，學習了如何抵禦攝魂怪的攻擊，這讓他對自己的能力有了更多的信心。

第五章：攝魂怪的影響
攝魂怪的出現讓霍格華茲的氣氛變得壓抑。哈利經常感到寒冷和絕望，他甚至在魁地奇比賽中因為攝魂怪的影響而從掃帚上摔了下來。鄧不利多校長對攝魂怪的出現表示擔憂。

第六章：魁地奇比賽
哈利在魁地奇比賽中表現出色，但他仍然受到攝魂怪的困擾。他決定向路平教授學習更強大的防禦魔法。

第七章：劫盜地圖
弗雷和喬治送給哈利一張「劫盜地圖」，這張地圖能顯示霍格華茲的每一個角落和所有人的位置。哈利利用這張地圖偷偷前往活米村，並在那裡聽到了關於天狼星·布萊克的更多傳聞。他得知布萊克是他的教父，並且被誣陷。

第八章：活米村之旅
哈利、榮恩和妙麗在活米村度過了愉快的時光，但哈利仍然無法擺脫對天狼星·布萊克的擔憂。他開始懷疑布萊克是否真的有罪。

第九章：格蘭芬多對雷文克勞
在又一場魁地奇比賽中，哈利再次面對攝魂怪。他成功地使用了護法咒，擊退了攝魂怪，並帶領格蘭芬多贏得了比賽。

第十章：天狼星·布萊克的真相
哈利、榮恩和妙麗在尖叫屋棚遇到了天狼星·布萊克。他們發現布萊克並不是殺害哈利父母的兇手，真正的兇手是彼得·佩迪魯，一個被認為已經死去的人。佩迪魯一直以榮恩的寵物老鼠斑斑的形態活著。

第十一章：背叛者彼得·佩迪魯
彼得·佩迪魯現出原形，他承認了自己的罪行。路平教授也透露了他的秘密：他是一名狼人。這個消息讓哈利和他的朋友們感到震驚。

第十二章：狼人的秘密
在月圓之夜，路平教授變成了狼人。天狼星·布萊克和哈利、榮恩、妙麗一起試圖制服他，但佩迪魯趁機逃脫了。

第十三章：時間轉換器
為了拯救天狼星·布萊克和鷹馬巴嘴，妙麗使用了時間轉換器。他們回到過去，改變了事件的發展。他們成功地解救了巴嘴，並幫助天狼星·布萊克逃脫。

第十四章：攝魂怪的吻
哈利和天狼星在湖邊被攝魂怪包圍。在絕望之際，哈利看到了遠處有一個強大的護法咒擊退了攝魂怪，他以為那是他的父親。

第十五章：護法咒
回到過去後，哈利意識到那個護法咒是他自己施展的。他成功地擊退了攝魂怪，拯救了自己和天狼星。

第十六章：阿茲卡班的逃犯
天狼星·布萊克成功逃脫，但他仍然是一名通緝犯。哈利和他的朋友們回到了現在，他們知道了一個巨大的秘密。

第十七章：貓頭鷹郵件（續）
學期結束，哈利收到了天狼星寄來的貓頭鷹，裡面有一封信和一隻小貓頭鷹。天狼星表示他已經安全，並送給哈利一隻新的貓頭鷹，作為他失去海德薇的補償。哈利知道，雖然天狼星還不能回到他身邊，但他們之間的羈絆將永遠存在。

第十八章：暑假與新的開始
哈利回到了德思禮家，但他不再像以前那樣感到孤單。他知道他有真正的朋友，還有一個關心他的教父。他期待著下一個學期的到來，以及新的冒險。
`;
            } else {
                // Original long content template for other novels
                const longContent = `## ${title}

第一章：星辰的呼喚與被選中的少年
在浩瀚無垠的宇宙深處，一顆被遺忘的藍色星球，正悄然孕育著一場足以改變銀河系命運的變革。主角艾瑞克，一個在邊緣殖民地長大的年輕人，他的生活平淡無奇，每天重複著農場的勞作，對外面的世界充滿了好奇卻又不敢奢望。直到某個寧靜的夜晚，一道前所未有的流星劃破天際，拖曳著絢麗的尾焰，最終墜落在他的農場後山。那並非尋常的隕石，而是一個古老文明的信標，它發出的微弱脈衝，如同遠古的低語，喚醒了艾瑞克血脈中沉睡的古老力量。一股不可抗拒的神秘力量開始引導他，促使他踏上了一條通往未知星系的旅程。他不知道，這趟旅程將揭示宇宙最深層的秘密，並將他推向一場關乎所有生命存亡的宏大戰爭。他的平凡人生，從此被徹底顛覆。

第二章：異星的邂逅與維斯珀族的預言
艾瑞克的飛船，一艘他費盡心血修復的破舊貨運船，穿越了數個星雲，避開了無數小行星帶，最終降落在一個被紫色植被覆蓋的陌生星球。這裡的空氣中瀰漫著奇異的芬芳，頭頂是兩輪巨大而詭異的月亮，散發著幽藍的光芒。他小心翼翼地走出飛船，警惕地觀察著周圍。很快，他遇到了一種奇特的智慧生物——一種名為「維斯珀」的發光生物。它們的身體由純粹的光構成，形態各異，卻都散發著溫和而古老的氣息。維斯珀族長老向他揭示了古老預言的碎片：一個來自星辰深處的「光之子」將會降臨，阻止即將吞噬一切的「虛空之影」。艾瑞克半信半疑，他只是一個農場少年，何德何能成為預言中的救世主？但他體內日益增強的力量，以及維斯珀族對他毫無保留的信任，讓他意識到自己或許就是預言中的那個人。他開始接受自己的命運，並準備好面對未知的挑戰。

第三章：虛空之影的威脅與星核的線索
「虛空之影」是一個跨維度的邪惡存在，它沒有固定的形態，卻能以最純粹的黑暗能量吞噬一切。它以吞噬星球的生命能量為生，所到之處只留下死寂和荒蕪。它的先鋒部隊，一群由黑暗能量驅動的機械軍團，已經開始入侵周邊星系，將和平的文明化為焦土。維斯珀族向艾瑞克解釋，只有傳說中的「星核」才能擊退虛空之影。星核是宇宙大爆炸時誕生的古老神器，蘊含著創世的能量。然而，星核的下落隱藏在宇宙最危險的禁區，一個被稱為「混沌星域」的地方。那裡充滿了致命的空間裂縫、失落文明的陷阱和強大的守護者。艾瑞克和維斯珀族組成了聯盟，他們必須找到星核，這是他們唯一的希望。

第四章：試煉之路與夥伴的羈絆
為了獲得星核，艾瑞克和他的夥伴們必須穿越混沌星域，通過一系列古老的試煉。他們首先穿越了充滿致命變異生物的「腐蝕叢林」，那裡的植物會主動攻擊一切生命。接著，他們進入了「時間迴廊」，一個失落文明的遺跡，必須解開複雜的謎題才能前進。他們甚至進入了精神領域，與內心的恐懼和過去的陰影搏鬥。每一次試煉都讓他們的力量和意志得到磨練，也讓他們之間的羈絆更加深厚。他們逐漸意識到，真正的力量不僅來自於超凡的能力，更來自於團結、信任和堅不可摧的信念。在一次次的生死考驗中，他們從陌生人變成了可以將後背交給對方的戰友。

第五章：意想不到的轉折與絕望中的希望
在故事的高潮部分，一個意想不到的轉折出現了。當他們即將抵達星核所在地時，他們最信任的盟友之一，竟然是虛空之影的臥底。這位盟友的背叛，讓艾瑞克和他的團隊陷入了前所未有的絕望。他們不僅失去了重要的線索，還被困在一個致命的陷阱中。更糟糕的是，虛空之影的真實身份也被揭示出來，它並非單純的邪惡，而是宇宙某種失衡的產物。在絕境中，艾瑞克必須找到一線生機，重新燃起希望的火焰。他回憶起導師的教誨，以及夥伴們的犧牲，最終領悟到，即使在最黑暗的時刻，也要堅守心中的光明。

第六章：光影之戰與最終的犧牲
最終的戰役在一個被虛空之影徹底侵蝕的星球上展開。天空被純粹的黑暗籠罩，地面被腐蝕得寸草不生。艾瑞克化身為光的戰士，他的身體閃耀著星核的璀璨光芒，與虛空之影展開了驚天動地的對決。光與影的碰撞，震盪著整個星系，能量波動甚至影響到了遠處的恆星。他的夥伴們也奮力抵抗虛空之影的機械軍團，為他爭取時間。這是一場消耗戰，也是意志的較量。艾瑞克意識到，要徹底擊敗虛空之影，他必須付出巨大的犧牲。他將星核的力量推向極致，以自己的生命為代價，將虛空之影徹底驅逐出這個維度，讓它回歸到宇宙的平衡之中。

第七章：和平的降臨與傳奇的延續
光芒散去，黑暗消退，和平重新降臨。被侵蝕的星球開始恢復生機，宇宙中的生命也感受到了這股新生的力量。艾瑞克雖然逝去，但他留下的傳說，將永遠銘刻在宇宙的歷史中。他的夥伴們繼承了他的遺志，繼續守護著銀河系的和平，並向所有文明傳播他的故事。他的犧牲並非終點，而是新生命的開始。在遙遠的未來，當新的威脅出現時，或許會有新的「光之子」再次被喚醒，繼續守護這片星辰大海。他的英雄事蹟，將激勵著一代又一代的生命。

第八章：新紀元的黎明
隨著虛空之影的消散，宇宙進入了一個新的紀元。各個文明之間建立了前所未有的友好關係，共同探索宇宙的奧秘，分享知識和技術。維斯珀族成為了和平的使者，引導著各個種族走向繁榮。科技和魔法以前所未有的速度發展，生命的形式也變得更加多樣和包容。艾瑞克的故事被傳頌萬代，成為了希望和勇氣的永恆象徵。他的精神，如同宇宙中的星光，照亮著每一個角落。

第九章：星海漫遊與不朽的影響
有人說，艾瑞克的靈魂並沒有真正消逝，而是化作了宇宙中的星辰，在無盡的星海中永恆漫遊，守護著他曾經奮戰過的文明。他的故事，是關於探索、犧牲與愛的史詩，將永遠激勵著生命，去追求更高遠的目標。即使在最偏遠的星球，孩子們也會聽著關於光之子的傳說入睡，心中充滿了對英雄的嚮往和對未來的憧憬。他的影響力超越了時間和空間，成為了宇宙秩序的一部分。

第十章：尾聲：永無止境的旅程
故事的終點，亦是新的起點。銀河系在和平中繁榮，但宇宙的奧秘永無止境。新的星球等待被發現，新的生命等待被創造，新的挑戰也終將會出現。艾瑞克的故事，是關於一個普通人如何超越自我，成為不朽傳奇的史詩。他的旅程證明了，即使是最微小的火花，也能點燃燎原之火，照亮整個宇宙的黑暗。而每一次的結束，都預示著下一個更宏大故事的開始。宇宙的旅程，永無止境。
`;
                return longContent;
            }
        }

        /**
         * Fetches novel content from Gemini API.
         * @param {string} title Novel title for prompt.
         * @param {string} genre Novel genre for prompt.
         * @returns {Promise<string>} The generated novel content.
         */
        async function fetchNovelContent(title, genre) {
            // Force Traditional Chinese for API generation
            const prompt = `請為我創作一篇長篇小說，主題是「${title}」，類型是「${genre}」。內容要引人入勝，至少包含五個章節，每個章節有標題和豐富的劇情。請確保故事完整且有結局。請使用繁體中文來寫作。`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || response.statusText}`);
                }

                // Attempt to parse JSON. If it fails, log the raw text response.
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    const rawText = await response.text();
                    console.error('JSON parsing error:', jsonError);
                    console.error('Raw API response:', rawText);
                    throw new Error(`API回傳無效的JSON格式。原始回應: ${rawText.substring(0, 200)}...`); // Show first 200 chars
                }

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('API回傳的內容不包含有效的小說文本。');
                }
            } catch (error) {
                console.error('Error in fetchNovelContent:', error);
                throw error; // Re-throw to be caught by calling function
            }
        }

        /**
         * Initializes all 50 novel metadata and preloads content for all of them.
         */
        function initializeAllNovels() {
            allNovels = [];

            // Add Harry Potter: Prisoner of Azkaban
            allNovels.push({
                id: `novel-hp-azkaban`,
                title: "哈利波特：阿茲卡班的逃犯",
                genre: "奇幻",
                description: "哈利波特系列第三部，天狼星·布萊克越獄，霍格華茲面臨前所未有的危機。",
                content: generateStaticNovelContent("哈利波特：阿茲卡班的逃犯", "奇幻"),
                isNew: false
            });


            for (let i = 0; i < TOTAL_INITIAL_NOVELS -1; i++) { // -1 because one is Harry Potter
                const genre = genres[Math.floor(Math.random() * genres.length)];
                const title = generateNovelTitle();
                const description = generateNovelDescription(genre);
                // All initial novels now have pre-generated static content
                const content = generateStaticNovelContent(title, genre);

                allNovels.push({
                    id: `novel-${i}`,
                    title: title,
                    genre: genre,
                    description: description,
                    content: content, // Content is now pre-generated
                    isNew: false
                });
            }
            renderNovels(allNovels); // Render all cards
            renderGenreFilters(); // Ensure filters are rendered
        }

        /**
         * Renders novel cards to the DOM based on a given array of novels.
         * @param {Array} novelsToRender The array of novel objects to render.
         */
        function renderNovels(novelsToRender) {
            novelList.innerHTML = ''; // Clear existing novels
            const filteredNovels = novelsToRender.filter(novel =>
                currentFilter === '所有' || novel.genre === currentFilter
            );

            if (filteredNovels.length === 0) {
                novelList.innerHTML = `<p class="text-center text-xl col-span-full text-gray-500">沒有找到符合條件的小說。</p>`;
                return;
            }

            filteredNovels.forEach(novel => {
                const card = document.createElement('div');
                card.id = novel.id;
                card.className = 'novel-card p-6 rounded-lg shadow-md flex flex-col cursor-pointer hover:border-purple-500';
                card.innerHTML = `
                    <h3 class="text-xl font-semibold text-purple-400 mb-2">${novel.title}</h3>
                    <p class="text-sm text-gray-500 mb-2">類型: ${novel.genre}</p>
                    <p class="text-sm text-gray-400 mb-4 flex-grow">${novel.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-green-400">
                            <i class="fas fa-unlock mr-1"></i>免費
                        </span>
                        ${novel.isNew ? '<span class="text-xs font-bold text-blue-400 ml-2">新生成</span>' : ''}
                        <button class="btn-primary text-sm px-3 py-1">閱讀</button>
                    </div>
                `;
                card.querySelector('button').addEventListener('click', () => openNovel(novel));
                novelList.appendChild(card);
            });
        }

        /**
         * Renders genre filter buttons.
         */
        function renderGenreFilters() {
            genreFilters.innerHTML = '';
            const allButton = document.createElement('button');
            allButton.className = 'px-4 py-2 rounded-full text-sm font-semibold transition-colors ' +
                                  (currentFilter === '所有' ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600');
            allButton.textContent = '所有';
            allButton.addEventListener('click', () => {
                currentFilter = '所有';
                renderGenreFilters(); // Re-render to update active state
                renderNovels(allNovels);
            });
            genreFilters.appendChild(allButton);

            genres.forEach(genre => {
                const button = document.createElement('button');
                button.className = 'px-4 py-2 rounded-full text-sm font-semibold transition-colors ' +
                                  (currentFilter === genre ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600');
                button.textContent = genre; // Genre names are fixed
                button.addEventListener('click', () => {
                    currentFilter = genre;
                    renderGenreFilters(); // Re-render to update active state
                    renderNovels(allNovels);
                });
                genreFilters.appendChild(button);
            });
        }

        /**
         * Opens the novel content modal. Content is assumed to be pre-generated.
         * @param {Object} novel The novel object to open.
         */
        async function openNovel(novel) {
            novelModal.classList.remove('hidden');
            novelTitleElem.textContent = novel.title;
            novelContentElem.innerHTML = '';
            bookValetBtn.classList.remove('hidden'); // Show book valet button

            // Content is always available now, no loading spinner for pre-loaded novels
            novelContentElem.innerHTML = novel.content.split('\n').map(line => {
                // Check if line is a chapter title (starts with ## or ###) and remove the hashes
                if (line.startsWith('## ')) {
                    return `<h3 class="text-2xl font-bold text-purple-300 mt-6 mb-3">${line.substring(3).trim()}</h3>`; // Trim to remove leading/trailing spaces
                } else if (line.startsWith('### ')) {
                    return `<h4 class="text-xl font-semibold text-purple-300 mt-5 mb-2">${line.substring(4).trim()}</h4>`; // Trim to remove leading/trailing spaces
                }
                return `<p class="mb-4">${line}</p>`;
            }).join('');
            currentNovelContent = novel.content;
            novelLoading.classList.add('hidden'); // Ensure loading spinner is hidden
        }

        /**
         * Generates a new novel card based on custom genre input.
         */
        async function generateCustomNovel() {
            const customGenre = customGenreInput.value.trim();
            if (!customGenre) {
                showMessage('請輸入您想生成的小說類型或主題！', 'error');
                return;
            }

            // Disable input and button, show loading status
            customGenreInput.disabled = true;
            generateCustomNovelBtn.disabled = true;
            generateCustomNovelBtn.classList.add('generate-btn-loading');
            generateBtnText.textContent = '生成中...';
            generateBtnSpinner.classList.remove('hidden');
            generateStatus.classList.remove('hidden');
            generateStatus.textContent = `正在為您生成關於 "${customGenre}" 的新小說，請稍候...`;


            try {
                const title = generateNovelTitle();
                const description = generateNovelDescription(customGenre);
                const content = await fetchNovelContent(title, customGenre); // Content generated in Traditional Chinese

                const newNovel = {
                    id: `novel-${Date.now()}`, // Unique ID
                    title: title,
                    genre: customGenre,
                    description: description,
                    content: content, // Store the generated content directly
                    isNew: true // Mark as newly generated
                };

                allNovels.unshift(newNovel); // Add to the beginning of the list
                renderNovels(allNovels); // Re-render all novels

                showMessage('新小說已成功生成並添加到列表中！', 'success');
            } catch (error) {
                console.error('Error generating custom novel content:', error);
                showMessage(`生成小說內容時發生錯誤: ${error.message}`, 'error');
            } finally {
                // Re-enable input and button, hide loading status
                customGenreInput.disabled = false;
                generateCustomNovelBtn.disabled = false;
                generateCustomNovelBtn.classList.remove('generate-btn-loading');
                generateBtnText.textContent = '生成新小說';
                generateBtnSpinner.classList.add('hidden');
                generateStatus.classList.add('hidden');
                customGenreInput.value = ''; // Clear input
            }
        }

        /**
         * Adds a chat message to the history.
         * @param {string} message The message text.
         * @param {string} sender 'user' or 'ai'.
         */
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${sender === 'user' ? 'chat-user' : 'chat-ai'}`;
            msgDiv.textContent = message;
            chatHistoryElem.appendChild(msgDiv);
            chatHistoryElem.scrollTop = chatHistoryElem.scrollHeight; // Scroll to bottom
        }

        /**
         * Sends a message to the book valet AI.
         */
        async function sendBookValetMessage() {
            const userQuestion = chatInput.value.trim();
            if (!userQuestion) return;

            addChatMessage(userQuestion, 'user');
            chatInput.value = ''; // Clear input

            if (!currentNovelContent) {
                addChatMessage('目前沒有小說內容可供提問。請先打開一本小說。', 'ai');
                return;
            }

            // Construct the prompt for the book valet
            const prompt = `你是一個專門回答小說內容問題的書僮。
            這是目前小說的內容：
            ---
            ${currentNovelContent}
            ---
            
            請只回答關於這本小說內容的問題。如果問題與小說內容無關，請回答：'我只能回答關於目前小說內容的問題喔。'
            
            請使用繁體中文來回答。
            我的問題是：${userQuestion}`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || response.statusText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addChatMessage(aiResponse, 'ai');
                } else {
                    addChatMessage('書僮暫時無法回答您的問題，請稍後再試。', 'ai');
                }
            } catch (error) {
                console.error('Error communicating with book valet AI:', error);
                addChatMessage(`書僮連接失敗: ${error.message}`, 'ai');
            }
        }

        /**
         * Switches the main content view between novels and comics.
         * @param {string} view 'novels' or 'comics'.
         */
        function switchView(view) {
            currentView = view;
            if (view === 'novels') {
                novelGenerationSection.classList.remove('hidden');
                novelFilterSection.classList.remove('hidden');
                novelList.classList.remove('hidden');
                comicsSection.classList.add('hidden');
            } else {
                novelGenerationSection.classList.add('hidden');
                novelFilterSection.classList.add('hidden');
                novelList.classList.add('hidden');
                comicsSection.classList.remove('hidden');
            }
        }

        /**
         * Simulates loading comics with a linear progress bar.
         */
        function loadComics() {
            comicsContent.innerHTML = ''; // Clear previous content
            comicsProgressBarContainer.style.display = 'block'; // Show progress bar
            comicsProgressBarFill.style.width = '0%'; // Reset progress

            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                comicsProgressBarFill.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(interval);
                    comicsProgressBarContainer.style.display = 'none'; // Hide progress bar
                    displayComics(); // Display comic content
                    showMessage('漫畫載入完成！', 'success');
                }
            }, 300); // Simulate 3 seconds loading
        }

        /**
         * Displays placeholder comic content.
         */
        function displayComics() {
            comicsContent.innerHTML = `
                <div class="bg-[#161b22] p-6 rounded-lg shadow-md border border-[#30363d]">
                    <h3 class="text-xl font-semibold text-purple-400 mb-2">星際探險隊：第一章</h3>
                    <p class="text-sm text-gray-400">在遙遠的未來，一支勇敢的探險隊踏上了尋找新家園的旅程。他們將面對未知的星球和神秘的生物。</p>
                    <img src="https://placehold.co/400x250/30363d/c9d1d9?text=漫畫封面1" alt="漫畫封面1" class="w-full h-auto rounded-md mt-4">
                </div>
                <div class="bg-[#161b22] p-6 rounded-lg shadow-md border border-[#30363d]">
                    <h3 class="text-xl font-semibold text-purple-400 mb-2">魔法學園：新生入學</h3>
                    <p class="text-sm text-gray-400">一個平凡的少年，意外獲得了魔法天賦，進入了傳說中的魔法學園。他的魔法之路充滿了挑戰與奇遇。</p>
                    <img src="https://placehold.co/400x250/30363d/c9d1d9?text=漫畫封面2" alt="漫畫封面2" class="w-full h-auto rounded-md mt-4">
                </div>
                <div class="bg-[#161b22] p-6 rounded-lg shadow-md border border-[#30363d]">
                    <h3 class="text-xl font-semibold text-purple-400 mb-2">都市異能者：覺醒</h3>
                    <p class="text-sm text-gray-400">在繁華的都市中，一股神秘的力量正在覺醒。普通人獲得了超能力，他們將如何面對這突如其來的變化？</p>
                    <img src="https://placehold.co/400x250/30363d/c9d1d9?text=漫畫封面3" alt="漫畫封面3" class="w-full h-auto rounded-md mt-4">
                </div>
            `;
        }

        // --- Event Listeners ---

        closeNovelModalBtn.addEventListener('click', () => {
            novelModal.classList.add('hidden');
            novelContentElem.innerHTML = ''; // Clear content
            currentNovelContent = ''; // Clear stored content
            bookValetBtn.classList.add('hidden'); // Hide book valet button
        });

        generateCustomNovelBtn.addEventListener('click', generateCustomNovel);

        bookValetBtn.addEventListener('click', () => {
            bookValetModal.classList.remove('hidden');
            chatInput.focus(); // Focus on input when modal opens
            chatHistoryElem.innerHTML = `<div class="chat-message chat-ai">您好，我是您的專屬書僮。請提出關於這本小說的問題。</div>`; // Reset chat history
        });

        closeBookValetModalBtn.addEventListener('click', () => {
            bookValetModal.classList.add('hidden');
        });

        sendChatBtn.addEventListener('click', sendBookValetMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission if any
                sendBookValetMessage();
            }
        });

        // Navigation button listeners
        document.getElementById('homeBtn').addEventListener('click', () => {
            switchView('novels');
        });

        onlineComicsBtn.addEventListener('click', () => {
            switchView('comics');
            loadComics(); // Trigger comic loading
        });


        // Initial setup on window load
        window.onload = function() {
            // Show startup animation
            startupAnimationOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling during animation

            setTimeout(() => {
                startupAnimationOverlay.classList.add('fade-out'); // Start fade out
                setTimeout(() => {
                    startupAnimationOverlay.style.display = 'none'; // Fully hide after fade
                    document.body.style.overflow = 'auto'; // Re-enable scrolling
                    header.classList.remove('hidden'); // Show header
                    main.classList.remove('hidden');   // Show main content
                    footer.classList.remove('hidden'); // Show footer
                    initializeAllNovels(); // Initialize novels after animation
                }, 1000); // Wait for fade-out transition (1s)
            }, 2000); // Show animation for 2 seconds
        };

    </script>
</body>
</html>
